from cryptography.fernet import Fernet
from random import choice
from string import ascii_lowercase, ascii_uppercase, digits
from ast import literal_eval


hiding_string_length = 10  # length of randomly generated string to hide digit of key length


def generate_random_str(length) -> str:
    return ''.join(choice(ascii_lowercase + ascii_uppercase + digits) for i in range(length))


def encrypt(value: str) -> str:
    if value is None or value == '':
        return ''
    key: bytes = Fernet.generate_key()
    fernet = Fernet(key)
    encrypted_value: bytes = fernet.encrypt(value.encode('utf-8'))

    length_digits = list(str(len(key)))
    if len(length_digits) != 2:
        return ''
    string_hiding_length = ''.join(generate_random_str(hiding_string_length - 1) + digit for digit in length_digits)

    # since key length is 32, base64 representation will contain only one '=' character in the end
    stripped_key = key.decode('utf-8').rstrip('=')
    # note that value has predictable part in the start with timestamp which is slightly changed over the time
    encrypted_value_str = encrypted_value.decode('utf-8')
    return string_hiding_length + stripped_key + encrypted_value_str


def decrypt(encrypted_dict: str) -> dict:
    if encrypted_dict is None or encrypted_dict == '':
        return {}

    string_hiding_digits = encrypted_dict[:hiding_string_length * 2]
    first_digit = string_hiding_digits[hiding_string_length - 1]
    second_digit = string_hiding_digits[hiding_string_length * 2 - 1]
    key_len = int(first_digit + second_digit)

    key_start_index = hiding_string_length * 2
    key_end_index = key_start_index + key_len - 1
    key = encrypted_dict[key_start_index: key_end_index] + '='

    value = encrypted_dict[key_end_index:]

    fernet = Fernet(key)
    decrypted_value = fernet.decrypt(value.encode('utf-8'))
    return literal_eval(decrypted_value.decode('utf-8'))


def test():
    test_value = "{'xmppsender': 'arman@xmpp.is', 'xmpppass': 'F#ckxmpp69!', 'xmpprecipient': 'init6@jabb3r.org'}"
    encrypted_value = encrypt(test_value)
    print(encrypted_value)

    print('========================')

    decrypted_value = decrypt(encrypted_value)
    print(type(decrypted_value))
    print(decrypted_value)
    print(decrypted_value['xmppsender'])


test()
